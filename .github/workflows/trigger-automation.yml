name: Trigger Automation Repo Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch to DemoAutomationRepo
        env:
          TOKEN: ${{ secrets.AUTOMATION_REPO_PAT }}
        run: |
          test -n "$TOKEN" || { echo "AUTOMATION_REPO_PAT is not set"; exit 1; }

          http_code=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/ug2454/DemoAutomationRepo/dispatches \
            -d '{
              "event_type":"dev-pr-updated",
              "client_payload":{
                "pr_url":"${{ github.event.pull_request.html_url }}",
                "head_sha":"${{ github.event.pull_request.head.sha }}",
                "branch":"${{ github.event.pull_request.head.ref }}"
              }
            }')

          cat response.json
          test "$http_code" = "204" || { echo "Dispatch failed with HTTP $http_code"; exit 1; }